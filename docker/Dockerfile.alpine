# FluxEncrypt Alpine Docker Image
# Minimal image based on Alpine Linux for smaller footprint

# Build stage
FROM rust:1.75-alpine as builder

# Install build dependencies
RUN apk add --no-cache \
    musl-dev \
    pkgconfig \
    openssl-dev \
    openssl-libs-static

# Set working directory
WORKDIR /usr/src/fluxencrypt

# Copy workspace configuration
COPY Cargo.toml Cargo.lock ./
COPY fluxencrypt/Cargo.toml ./fluxencrypt/
COPY fluxencrypt-cli/Cargo.toml ./fluxencrypt-cli/
COPY fluxencrypt-async/Cargo.toml ./fluxencrypt-async/

# Create dummy source files to cache dependencies
RUN mkdir -p fluxencrypt/src fluxencrypt-cli/src fluxencrypt-async/src \
    && echo "fn main() {}" > fluxencrypt-cli/src/main.rs \
    && echo "fn main() {}" > fluxencrypt/src/lib.rs \
    && echo "fn main() {}" > fluxencrypt-async/src/lib.rs

# Build dependencies with static linking
ENV RUSTFLAGS="-C target-feature=-crt-static"
RUN cargo build --release --workspace
RUN rm -rf fluxencrypt/src fluxencrypt-cli/src fluxencrypt-async/src

# Copy actual source code
COPY . .

# Build the application
RUN cargo build --release --bin fluxencrypt

# Runtime stage
FROM alpine:3.18

# Install runtime dependencies
RUN apk add --no-cache \
    ca-certificates \
    && adduser -D -s /bin/sh fluxencrypt

# Copy the binary from builder stage
COPY --from=builder /usr/src/fluxencrypt/target/release/fluxencrypt /usr/local/bin/fluxencrypt

# Set proper permissions
RUN chmod +x /usr/local/bin/fluxencrypt

# Create data directory
RUN mkdir -p /data && chown fluxencrypt:fluxencrypt /data

# Switch to non-root user
USER fluxencrypt

# Set working directory
WORKDIR /data

# Default command
ENTRYPOINT ["fluxencrypt"]
CMD ["--help"]

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD fluxencrypt --version || exit 1

# Labels for metadata
LABEL org.opencontainers.image.title="FluxEncrypt Alpine"
LABEL org.opencontainers.image.description="Secure encryption SDK and CLI (Alpine Linux)"
LABEL org.opencontainers.image.version="0.1.0"
LABEL org.opencontainers.image.authors="Wyatt Roersma, Claude Code, Codex"
LABEL org.opencontainers.image.vendor="ThreatFlux Organization"
LABEL org.opencontainers.image.licenses="MIT"
LABEL org.opencontainers.image.documentation="https://github.com/ThreatFlux/fluxencrypt"
LABEL org.opencontainers.image.source="https://github.com/ThreatFlux/fluxencrypt"